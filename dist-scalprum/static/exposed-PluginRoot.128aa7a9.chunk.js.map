{"version":3,"file":"static/exposed-PluginRoot.128aa7a9.chunk.js","mappings":"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","sources":["webpack://plugin-web-rca/./src/components/WebRCAFetchComponent/WebRCAFetchComponent.tsx","webpack://plugin-web-rca/./src/routes.ts","webpack://plugin-web-rca/./src/plugin.ts"],"sourcesContent":["import React from 'react';\nimport {\n  Table,\n  TableColumn,\n  Progress,\n  ResponseErrorPanel,\n} from '@backstage/core-components';\nimport useAsync from 'react-use/lib/useAsync';\nimport { useApi, configApiRef, identityApiRef, OpenIdConnectApi, OAuthApi, ProfileInfoApi, BackstageIdentityApi, SessionApi, createApiRef } from '@backstage/core-plugin-api';\nimport '@backstage/plugin-user-settings';\nimport { Typography } from '@material-ui/core';\nimport { InfoCard } from '@backstage/core-components';\nimport { useEntity } from '@backstage/plugin-catalog-react';\n\ninterface DenseTableProps {\n  incidents?: IncidentList;\n  web_rca_url?: string;\n  message?: string;\n}\n\ninterface Incident {\n  id?: string;\n  kind?: string;\n  href?: string;\n  incident_id?: string;\n  summary?: string;\n  description?: string;\n}\n// jq '{kind, page, size, total, items: [.items[] | {id, kind, href, incident_id, summary, description}]}'\ninterface IncidentList {\n  kind: 'IncidentList';\n  page?: number;\n  size?: number;\n  total?: number;\n  items?: Incident[];\n  errorMsg?: string;\n}\n\ninterface product {\n  id: string;\n  kind: string;\n  href: string;\n  name: string;\n  fullname: string;\n}\n\ninterface productList {\n  items: product[];\n}\n\ninterface FetchProps {\n  product?: string;\n}\n\nexport const DenseTable = ({\n  incidents,\n  web_rca_url,\n  message,\n}: DenseTableProps) => {\n  if (message) {\n    return (\n      <InfoCard title=\"Web RCA Incidents\">\n        <Typography variant=\"body1\">{\"Error fetching incidents: \" + message }</Typography>\n      </InfoCard>\n    );\n  }\n\n  if (!incidents || !incidents.items || incidents.items.length === 0) {\n    return (\n      <InfoCard title=\"Web RCA Incidents\">\n        <Typography variant=\"body1\">\"Error fetching incidents: No Incidents\"</Typography>\n      </InfoCard>\n    );\n  }\n\n  if (!incidents || !incidents.items || incidents.items.length === 0) {\n    return (\n      <InfoCard title=\"Web RCA Incidents\">\n        <Typography variant=\"body1\">{\"Error fetching incidents: \" + message }</Typography>\n      </InfoCard>\n    );\n  }\n\n\n  const columns: TableColumn[] = [\n    { title: 'ID', field: 'incident_id' },\n    { title: 'Summary', field: 'summary' },\n    { title: 'Description', field: 'description' },\n  ];\n\n  const data = incidents.items.map(inc => {\n    return {\n      incident_id: (\n        <a\n          target=\"_blank\"\n          rel=\"noreferrer\"\n          href={`${web_rca_url}/incident/${inc.incident_id}/details`}\n        >\n          {inc.incident_id}\n        </a>\n      ),\n      summary: inc.summary,\n      description: inc.description,\n    };\n  });\n\n  return (\n    <Table\n      title=\"Web RCA Incidents\"\n      options={{ search: true, paging: true, pageSize: 10 }}\n      columns={columns}\n      data={data}\n    />\n  );\n};\n\nasync function refresh(url: string, client_id: string, client_secret: string) {\n  // @REF [URL Encoded form body](https://stackoverflow.com/questions/35325370/how-do-i-post-a-x-www-form-urlencoded-request-using-fetch/37562814#37562814)\n  const details: { [index: string]: string } = {\n    grant_type: 'client_credentials',\n    client_id: client_id,\n    client_secret: client_secret,\n    scope: 'openid api.ocm',\n  };\n\n  const formBody = [];\n  for (const property in details) {\n    if (Object.prototype.hasOwnProperty.call(details, property)) {\n      const encodedKey: string = encodeURIComponent(property);\n      const encodedValue: string = encodeURIComponent(details[property]);\n      formBody.push(`${encodedKey}=${encodedValue}`);\n    }\n  }\n  const formBodyString = formBody.join('&');\n\n  return await fetch(\n    `${url}/api/proxy/sso-redhat/auth/realms/redhat-external/protocol/openid-connect/token`,\n    {\n      method: 'POST',\n      body: formBodyString,\n      headers: {\n        'Content-Type': 'application/x-www-form-urlencoded',\n      },\n    },\n  )\n    .catch(error => error)\n    .then(resp => resp.json());\n}\n\nasync function lookupProduct(\n  url: string,\n  access_token: string,\n  product_name: string,\n): Promise<productList> {\n  return (await fetch(\n    `${url}/api/proxy/status-board/products?search=fullname+ilike+'${product_name}'`,\n    {\n      headers: {\n        Authorization: `Bearer ${access_token}`,\n      },\n    },\n  )\n    .catch(error => error)\n    .then(resp => resp.json())) as productList;\n}\n\nexport const WebRCAFetchComponent = ({ product }: FetchProps) => {\n  const config = useApi(configApiRef);\n  const user = useApi(identityApiRef);\n  const entity = useEntity();\n  type CustomAuthApiRefType = OAuthApi & OpenIdConnectApi & ProfileInfoApi & BackstageIdentityApi & SessionApi;\n\n  // @REF [Janus oidc config](https://github.com/janus-idp/backstage-showcase/blob/e1e62157e9b467eed0c6ab446a9df597b46e3333/packages/app/src/api/AuthApiRefs.ts#L2)\n  const f: CustomAuthApiRefType = useApi(createApiRef({\n    id: 'internal.auth.oidc',\n  }));\n  // const f = useApi(createApiRef<OpenIdConnectApi>({id: 'oidc'}));\n  // f.getIdToken({optional: false, instantPopup: false});\n\n  const { value, loading, error } = useAsync(async (): Promise<\n    IncidentList | string\n  > => {\n      // TODO: Should we limit to owner/mine?\n      //\n      const profile_info = await user.getProfileInfo().then((pi) => {\n        return pi;\n      })\n      console.log(\"Profile Info: \", profile_info);\n      const backstage_identity = await user.getBackstageIdentity().then((bi) => {\n        return bi;\n      })\n      console.log(\"Backstage Identity: \", backstage_identity);\n      const refresh_token = await user.getCredentials().then((creds) => {\n        console.log(creds);\n        console.log(creds.token);\n        return creds.token;\n      });\n      if (refresh_token === undefined) {\n        return 'Invalid token';\n      }\n      console.log(\"Refresh Token: \", refresh_token);\n      let token = refresh_token;\n\n      let oidcToken = await f.getIdToken({optional: false, instantPopup: false});\n      console.log(\"OIDC Token: \", oidcToken);\n      let default_token;\n      try {\n        default_token = await refresh(\n          config.getString('backend.baseUrl'),\n          config.getString('ocm.clientId'),\n          config.getString('ocm.clientSecret'),\n        );\n      } catch (e) {\n        console.log(\"Error: \", e);\n        return 'Invalid token';\n      }\n      if (default_token.error) {\n        return default_token.error_description;\n      }\n\n      let products = '';\n      if (product) {\n        let p;\n        try {\n          p = await lookupProduct(\n            config.getString('backend.baseUrl'),\n            // token.access_token,\n            token,\n            product,\n          );\n        } catch {\n          console.log(\"Error using user token, falling back to default token\");\n          p = await lookupProduct(\n            config.getString('backend.baseUrl'),\n            default_token.access_token,\n            product,\n          );\n        }\n        if (p.items && p.items.length > 0) {\n          products = `?product_id=${p.items[0].id}`;\n        }\n      }\n      if (entity) {\n        let p;\n        try {\n          p = await lookupProduct(\n            config.getString('backend.baseUrl'),\n            // token.access_token,\n            token,\n            entity.entity.metadata.name,\n          );\n          if (p.items.length > 0) {\n            products = `?product_id=${p.items[0].id}`;\n          }\n        } catch {\n          console.log(\"Error using user token, falling back to default token\");\n          token = default_token.access_token;\n          p = await lookupProduct(\n            config.getString('backend.baseUrl'),\n            token,\n            entity.entity.metadata.name,\n          );\n          if (p.items && p.items.length > 0) {\n            products = `?product_id=${p.items[0].id}`;\n          }\n          }\n      }\n\n      if (products === '') {\n        return 'No product based on entity';\n      }\n\n      let incidentList;\n      // TODO: Filter by status?  Add a toggle?\n      incidentList = await fetch(\n        `${config.getString('backend.baseUrl')}/api/proxy/web-rca/incidents${products}`,\n        {\n          headers: {\n            // Authorization: `Bearer ${token.access_token}`,\n            Authorization: `Bearer ${token}`,\n          },\n        },\n      )\n        .then(resp => resp.json())\n        .catch(e => e);\n\n      return incidentList as Promise<IncidentList>;\n    }, []);\n\n  if (loading) {\n    return <Progress />;\n  }\n  if (error) {\n    return <ResponseErrorPanel error={error} />;\n  }\n  if (!value) {\n    return (\n      <ResponseErrorPanel\n        error={{\n          name: 'Foo',\n          message: 'Foo',\n        }}\n      />\n    );\n  }\n\n  if (typeof value === 'string') {\n    return (\n      <DenseTable\n        message={value}\n        web_rca_url={config.getString('ocm.webRcaUIUrl')}\n      />\n    );\n  }\n\n  return (\n    <DenseTable\n      incidents={value}\n      web_rca_url={config.getString('ocm.webRcaUIUrl')}\n    />\n  );\n};\n","import { createRouteRef } from '@backstage/core-plugin-api';\n\nexport const rootRouteRef = createRouteRef({\n  id: 'web-rca',\n});\n","import {\n  createPlugin,\n  createRoutableExtension,\n} from '@backstage/core-plugin-api';\n\nimport { rootRouteRef } from './routes';\n\nexport const webRcaPlugin = createPlugin({\n  id: 'web-rca',\n  routes: {\n    root: rootRouteRef,\n  },\n});\n\nexport const WebRcaPage = webRcaPlugin.provide(\n  createRoutableExtension({\n    name: 'WebRcaPage',\n    component: () =>\n      import('./components/WebRCAComponent').then(m => m.WebRCAComponent),\n    // import('./components/WebRCAFetchComponent').then(m => m.WebRCAFetchComponent),\n    mountPoint: rootRouteRef,\n  }),\n);\n"],"names":["DenseTable","incidents","web_rca_url","message","InfoCard","title","Typography","variant","items","length","data","map","inc","incident_id","a","target","rel","href","summary","description","Table","options","search","paging","pageSize","columns","field","async","lookupProduct","url","access_token","product_name","fetch","headers","Authorization","catch","error","then","resp","json","WebRCAFetchComponent","product","config","useApi","configApiRef","user","identityApiRef","entity","useEntity","f","createApiRef","id","value","loading","useAsync","profile_info","getProfileInfo","pi","console","log","backstage_identity","getBackstageIdentity","bi","refresh_token","getCredentials","creds","token","undefined","default_token","oidcToken","getIdToken","optional","instantPopup","client_id","client_secret","details","grant_type","scope","formBody","property","Object","prototype","hasOwnProperty","call","encodedKey","encodeURIComponent","encodedValue","push","formBodyString","join","method","body","refresh","getString","e","error_description","incidentList","products","p","metadata","name","Progress","ResponseErrorPanel","rootRouteRef","createRouteRef","webRcaPlugin","createPlugin","routes","root","WebRcaPage","provide","createRoutableExtension","component","m","WebRCAComponent","mountPoint"],"sourceRoot":""}